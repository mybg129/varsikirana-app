<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Varsi General Store â€” Customer</title>
<style>
body{
font-family:system-ui,Arial;margin:0;background:#f6f9fc;padding:12px;color:#111}
.container{max-width:520px;margin:8px auto}
.header{display:flex;gap:10px;align-items:center;margin-bottom:10px}
/* .logo{width: 120px;height: 120px;border-radius: 50%;background: #fff;display:flex;align-items:center;justify-content:center;box-shadow: 0 4px 12px rgba(0,0,0,0.1);} */
.top-logo {
    text-align: center;
    padding: 15px 0;
}

.top-logo img {
    width: 120px;     /* logo size perfect mobile UI */
    height: 120px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
}

.top-logo h2 {
    margin-top: 8px;
    font-size: 22px;
    font-weight: 700;
}

/* .logo img{width: 90%;height: 90%;object-fit: contain;} */
.card{background:#fff;padding:12px;border-radius:12px;margin-top:10px;box-shadow:0 6px 18px rgba(11,84,150,0.06)}
.row{display:flex;gap:8px;align-items:center}
.input{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eefc}
.btn{padding:10px 12px;border-radius:8px;border:0;background:#0b7cff;color:white;font-weight:700;cursor:pointer}
.qty{width:86px;padding:8px;border-radius:8px;border:1px solid #eee;text-align:right}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #fafafa}
.total{font-size:18px;font-weight:700;text-align:center;margin-top:10px}
.small{font-size:13px;color:#666}
@media(max-width:520px){ .qty{width:100%}} .row{flex-direction:column} 
</style>
</head>
<body>
<div class="container">
  <div class="header card"> <div>
    <div class="top-logo"><img src="Varsi_kirana.png" alt="logo"></div></div>
      <h2 id="shopName">Varsi General Store</h2>
   
      <div class="small">Ghar se choose karein â€” store se pickup</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="custName" class="input" placeholder="Your name">
      <input id="custPhone" class="input" placeholder="Mobile number">
    </div>

    <div id="catalog" class="catalog-section"></div>

    <div class="total" id="total">Total: â‚¹0.00</div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="whatsBtn" class="btn">Send Order on WhatsApp</button>
      <button id="invoiceBtn" class="btn" style="background:#fff;color:#0b7cff;border:1px solid #0b7cff">Print Invoice</button>
      <button id="downloadBtn" class="btn" style="background:#fff;color:#0b7cff;border:1px solid #0b7cff">Download CSV</button>
    </div>

    <div class="small" style="margin-top:8px">Tip: Enter kg and/or gram for items. Gram auto-converts to kg for price calculation.</div>
  </div>
</div>

<script>
let catalog = (function(){
  const saved = localStorage.getItem('vg_catalog');
  if(saved){ try{ return JSON.parse(saved); }catch(e){} }
  return [
    {id:"tuvar",cat:"Daal",name:"Tuvar Dal",price:120,unit:"kg",stock:20,icon:"ðŸ«˜"},
    {id:"moong",cat:"Daal",name:"Moong Dal",price:140,unit:"kg",stock:15,icon:"ðŸ«˜"},
    {id:"masoor",cat:"Daal",name:"Masoor Dal",price:95,unit:"kg",stock:18,icon:"ðŸ«˜"},
    {id:"besan",cat:"Atta",name:"Besan",price:45,unit:"kg",stock:10,icon:"ðŸŒ¾"},
    {id:"kolam",cat:"Rice",name:"Kolam Rice",price:55,unit:"kg",stock:30,icon:"ðŸš"},
    {id:"pamoline",cat:"Oil",name:"Pamoline Oil",price:80,unit:"ltr",stock:40,icon:"ðŸ›¢"}
  ];
})();

let SHOP_PHONE = localStorage.getItem('vg_shopphone') || 'REPLACE_WITH_SHOP_NUMBER';
let SHOP_NAME = localStorage.getItem('vg_shopname') || document.getElementById('shopName').innerText;

function groupBy(arr,key){ return arr.reduce((r,i)=>{ (r[i[key]] = r[i[key]]||[]).push(i); return r; }, {}); }

function renderCatalog(){
  const container = document.getElementById('catalog'); container.innerHTML='';
  const byCat = groupBy(catalog,'cat');
  Object.keys(byCat).forEach(cat=>{
    const sec = document.createElement('div'); sec.className='card';
    sec.innerHTML = `<div style="padding:8px 0;display:flex;justify-content:space-between;align-items:center"><strong>${cat}</strong><span class="small">Tap to expand</span></div><div class="items" id="items-${cat.replace(/\\s+/g,'_')}" style="display:block"></div>`;
    container.appendChild(sec);
    const items = sec.querySelector('.items');
    byCat[cat].forEach(p=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div style="display:flex;flex-direction:column"><div><strong>${p.name}</strong></div><div class="small" id="stock-${p.id}">Stock: ${p.stock===null?'â€”':p.stock}</div></div>
        <div style="text-align:right"><div class="small">â‚¹${p.price}/${p.unit}</div>
        <div style="margin-top:6px;display:flex;gap:6px">
          <input class="qty_kg" data-id="${p.id}" data-price="${p.price}" placeholder="kg" type="number" min="0" step="any" style="width:80px;padding:6px;border-radius:6px;border:1px solid #eee">
          <input class="qty_gm" data-id="${p.id}" data-price="${p.price}" placeholder="gm" type="number" min="0" step="any" style="width:80px;padding:6px;border-radius:6px;border:1px solid #eee">
        </div></div>`;
      items.appendChild(row);
    });
  });
  attachListeners();
}

function attachListeners(){
  document.querySelectorAll('.qty_kg, .qty_gm').forEach(i=> i.addEventListener('input', ()=>{ updateTotal(); updateStockIndicators(); }));
}

function updateTotal(){
  let total = 0;
  document.querySelectorAll('.qty_kg').forEach(kg=>{
    const id = kg.dataset.id;
    const gm = document.querySelector(`.qty_gm[data-id="${id}"]`);
    const kgVal = parseFloat(kg.value)||0;
    const gmVal = parseFloat(gm.value)||0;
    const weightKg = kgVal + (gmVal/1000);
    const pricePerKg = parseFloat(kg.dataset.price)||0;
    total += weightKg * pricePerKg;
  });
  document.getElementById('total').innerText = `Total: â‚¹${total.toFixed(2)}`;
}

function updateStockIndicators(){
  document.querySelectorAll('.qty_kg').forEach(kg=>{
    const id = kg.dataset.id;
    const gm = document.querySelector(`.qty_gm[data-id="${id}"]`);
    const kgVal = parseFloat(kg.value)||0;
    const gmVal = parseFloat(gm.value)||0;
    const needed = kgVal + (gmVal/1000);
    const p = catalog.find(x=>x.id===id);
    const el = document.getElementById('stock-'+id);
    if(p && p.stock!==null && needed>p.stock){ el.style.color='orange'; el.textContent = `Only ${p.stock} ${p.unit} left`; } else { el.style.color='green'; el.textContent = `Stock: ${p.stock===null?'â€”':p.stock}`; }
  });
}

function buildOrder(){
  const name = document.getElementById('custName').value||'';
  const phone = document.getElementById('custPhone').value||'';
  const items = []; let total=0;
  document.querySelectorAll('.qty_kg').forEach(kg=>{
    const id = kg.dataset.id;
    const gm = document.querySelector(`.qty_gm[data-id="${id}"]`);
    const kgVal = parseFloat(kg.value)||0;
    const gmVal = parseFloat(gm.value)||0;
    const weightKg = Math.round((kgVal + (gmVal/1000))*1000)/1000;
    if(weightKg>0){
      const pricePerKg = parseFloat(kg.dataset.price)||0;
      const line = weightKg * pricePerKg;
      const p = catalog.find(x=>x.id===id) || {name:kg.dataset.name||id,unit:kg.placeholder};
      items.push({id:id,name:p.name,weightKg:weightKg,unit:'kg',price:pricePerKg,line:line});
      total += line;
    }
  });
  return {name,phone,items,total};
}

document.getElementById('whatsBtn').addEventListener('click', ()=>{
  const order = buildOrder();
  if(order.items.length===0){ alert('Please add items'); return; }
  if(!SHOP_PHONE || SHOP_PHONE==='REPLACE_WITH_SHOP_NUMBER'){ alert('Shop phone not set. Ask admin to set it.'); return; }
  let text = `${document.getElementById('shopName').innerText}\\nCustomer: ${order.name}\\nPhone: ${order.phone}\\n\\n`;
  order.items.forEach(it=> text += `${it.name} â€” ${it.weightKg.toFixed(3)} kg Ã— â‚¹${it.price} = â‚¹${it.line.toFixed(2)}\\n`);
  text += `\\nTotal: â‚¹${order.total.toFixed(2)}`;
  window.open(`https://wa.me/${SHOP_PHONE.replace('+','')}?text=${encodeURIComponent(text)}`,'_blank');
});

document.getElementById('invoiceBtn').addEventListener('click', ()=>{
  const order = buildOrder(); if(order.items.length===0){ alert('Please add items'); return; }
  const now = new Date(); let html = `<html><head><meta charset="utf-8"><title>Invoice</title><style>body{{font-family:Arial;padding:14px}}table{{width:100%;border-collapse:collapse}}td,th{{border:1px solid #ddd;padding:6px}}</style></head><body>`;
  html += `<h2>${document.getElementById('shopName').innerText}</h2><div>${now.toLocaleString()}</div><div>Customer: ${order.name} | ${order.phone}</div>`;
  html += `<table><thead><tr><th>Item</th><th>Qty (kg)</th><th>Price/kg</th><th>Line</th></tr></thead><tbody>`;
  order.items.forEach(it=> html += `<tr><td>${it.name}</td><td>${it.weightKg.toFixed(3)}</td><td>â‚¹${it.price}</td><td>â‚¹${it.line.toFixed(2)}</td></tr>`);
  html += `<tfoot><tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td>â‚¹${order.total.toFixed(2)}</td></tr></tfoot></table></body></html>`;
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const order = buildOrder(); if(order.items.length===0){ alert('No items selected'); return; }
  const rows = [['Shop','Customer','Phone','Item','Qty(kg)','Price/kg','Line']];
  order.items.forEach(it=> rows.push(['Varsi General Store',order.name,order.phone,it.name,it.weightKg.toFixed(3),it.price,it.line.toFixed(2)]));
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
  const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='order.csv'; a.click();
});

renderCatalog();
updateTotal();
</script>
</body>

</html>











